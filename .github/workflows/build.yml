name: Build NanaBox Lite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Disponibiliza o msbuild no PATH
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      # Build do CLI (nanabox-lite.exe)
      - name: Build CLI (nanabox-lite.exe)
        run: |
          msbuild /m /p:Configuration=Release /p:Platform=x64 src/nanabox-lite/nanabox-lite.vcxproj
        shell: pwsh

      # Instala o Windows Driver Kit (WDK) necessário para compilar drivers KM
      - name: Install Windows Driver Kit (WDK)
        shell: pwsh
        run: |
          choco install -y windows-driver-kit
          # Verifica instalação e detecta versão mais alta instalada
          $wdkRoot = 'C:\Program Files (x86)\Windows Kits\10'
          if (-not (Test-Path $wdkRoot)) {
            Write-Error "WDK não encontrado em $wdkRoot após instalação"
            exit 1
          }
          $incVer = Get-ChildItem -Directory "$wdkRoot\Include" | Sort-Object Name -Descending | Select-Object -First 1
          if (-not $incVer) {
            Write-Error "Nenhuma versão do Windows Kits encontrada em $wdkRoot\Include"
            exit 1
          }
          $wdkIncKm = Join-Path $wdkRoot ("Include\$($incVer.Name)\km")
          $wdkLibKm = Join-Path $wdkRoot ("Lib\$($incVer.Name)\km\x64")
          Write-Host "WDK KM include: $wdkIncKm"
          Write-Host "WDK KM lib: $wdkLibKm"
          # exporta para próximos steps via GITHUB_ENV
          Add-Content $env:GITHUB_ENV "WDK_INC=$wdkIncKm"
          Add-Content $env:GITHUB_ENV "WDK_LIB=$wdkLibKm"

      # Build do driver (nanabox_hvfilter.sys) - desativando InfVerif/Inf2Cat no CI
      - name: Build driver (nanabox_hvfilter.sys)
        shell: pwsh
        env:
          INCLUDE: ${{ env.WDK_INC }};${{ env.INCLUDE }}
          LIB: ${{ env.WDK_LIB }};${{ env.LIB }}
        run: |
          msbuild driver\nanabox_hvfilter.vcxproj `
            /m `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:RunInf2Cat=false `
            /p:RunInfVerif=false

      # Passo de debug: mostra onde os binários foram gerados
      - name: List build outputs
        run: |
          Write-Host "=== Procurando nanabox-lite.exe ==="
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -ieq "nanabox-lite.exe" }
          Write-Host "`n=== Procurando nanabox_hvfilter.sys ==="
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -ieq "nanabox_hvfilter.sys" }
        shell: pwsh

      - name: Prepare artifact
        run: |
          New-Item -ItemType Directory -Path artifact -Force | Out-Null

          # CLI
          Copy-Item -Path ".\src\nanabox-lite\build\Release\x64\nanabox-lite.exe" `
                    -Destination ".\artifact\" -Force

          # Driver .sys (copiar somente se existir)
          if (Test-Path ".\driver\build\Release\x64\nanabox_hvfilter\nanabox_hvfilter.sys") {
            Copy-Item -Path ".\driver\build\Release\x64\nanabox_hvfilter\nanabox_hvfilter.sys" `
                      -Destination ".\artifact\" -Force
          } else {
            Write-Host "Driver .sys não encontrado — pulando cópia"
          }

          # Driver .inf (fonte)
          Copy-Item -Path ".\driver\nanabox_hvfilter.inf" `
                    -Destination ".\artifact\" -Force

          # Script de instalação
          if (Test-Path ".\scripts\install.ps1") {
            Copy-Item -Path ".\scripts\install.ps1" `
                      -Destination ".\artifact\" -Force
          }

          # Perfis (por ex. roblox-lite.json)
          if (Test-Path ".\profiles") {
            Copy-Item -Path ".\profiles" `
                      -Destination ".\artifact\profiles" -Recurse -Force
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanabox-lite-bundle
          path: artifact
