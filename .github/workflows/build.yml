name: Build NanaBox Lite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Se você já usa dotnet/cmake etc. pra buildar o CLI, mantenha aqui.
      # Exemplo genérico de build do nanabox-lite.exe:
      - name: Build CLI (nanabox-lite.exe)
        run: |
          msbuild /m /p:Configuration=Release /p:Platform=x64 nanabox-lite.vcxproj
        shell: pwsh

      - name: Build driver (nanabox_hvfilter.sys)
        run: |
          msbuild /m /p:Configuration=Release /p:Platform=x64 .\driver\nanabox_hvfilter.vcxproj
        shell: pwsh

      - name: List build outputs
        run: |
          Write-Host "=== CLI binaries ==="
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "nanabox-lite.exe" }
          Write-Host "=== Driver binaries ==="
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "nanabox_hvfilter.sys" }
        shell: pwsh

      - name: Prepare artifact
        run: |
          New-Item -ItemType Directory -Path artifact -Force | Out-Null

          # Ajuste estes caminhos se o .exe estiver em outro lugar
          Copy-Item -Path ".\build\Release\x64\nanabox-lite.exe" -Destination ".\artifact\" -Force -ErrorAction Stop

          # Driver sys gerado pelo vcxproj do driver
          Copy-Item -Path ".\driver\x64\Release\nanabox_hvfilter.sys" -Destination ".\artifact\" -Force -ErrorAction Stop
          # INF do driver
          Copy-Item -Path ".\driver\nanabox_hvfilter.inf" -Destination ".\artifact\" -Force -ErrorAction Stop

          # Script e perfis
          Copy-Item -Path ".\scripts\install.ps1" -Destination ".\artifact\" -Force -ErrorAction Stop
          if (Test-Path ".\profiles") {
            Copy-Item -Path ".\profiles" -Destination ".\artifact\profiles" -Recurse -Force -ErrorAction Stop
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanabox-lite-bundle
          path: artifact
