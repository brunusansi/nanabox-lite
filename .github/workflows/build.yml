name: Build NanaBox Lite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Use windows-2022 because it includes WDK preinstalled
    # windows-latest (Windows Server 2025) dropped WDK support
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Expose msbuild on PATH
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      # Build CLI (nanabox-lite.exe)
      - name: Build CLI (nanabox-lite.exe)
        run: |
          msbuild /m /p:Configuration=Release /p:Platform=x64 src/nanabox-lite/nanabox-lite.vcxproj
        shell: pwsh

      # Build driver (nanabox_hvfilter.sys)
      - name: Build driver (nanabox_hvfilter.sys)
        run: |
          msbuild /m /p:Configuration=Release /p:Platform=x64 driver\nanabox_hvfilter.vcxproj
        shell: pwsh

      # Debug step: show where binaries were generated
      - name: List build outputs
        run: |
          Write-Host "=== Looking for nanabox-lite.exe ==="
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -ieq "nanabox-lite.exe" }
          Write-Host "`n=== Looking for nanabox_hvfilter.sys ==="
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -ieq "nanabox_hvfilter.sys" }
        shell: pwsh

      - name: Prepare artifact
        run: |
          New-Item -ItemType Directory -Path artifact -Force | Out-Null

          # CLI
          # Based on OutDir in vcxproj: $(SolutionDir)build\$(Configuration)\$(Platform)\
          # When building standalone vcxproj, SolutionDir = project directory
          Copy-Item -Path ".\src\nanabox-lite\build\Release\x64\nanabox-lite.exe" `
                    -Destination ".\artifact\" -Force

          # Driver .sys
          # Based on OutDir in vcxproj: $(SolutionDir)build\$(Configuration)\$(Platform)\
          # When building standalone vcxproj, SolutionDir = project directory
          Copy-Item -Path ".\driver\build\Release\x64\nanabox_hvfilter.sys" `
                    -Destination ".\artifact\" -Force

          # Driver .inf (source)
          Copy-Item -Path ".\driver\nanabox_hvfilter.inf" `
                    -Destination ".\artifact\" -Force

          # Installation script
          if (Test-Path ".\scripts\install.ps1") {
            Copy-Item -Path ".\scripts\install.ps1" `
                      -Destination ".\artifact\" -Force
          }

          # Profiles (e.g., roblox-lite.json)
          if (Test-Path ".\profiles") {
            Copy-Item -Path ".\profiles" `
                      -Destination ".\artifact\profiles" -Recurse -Force
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanabox-lite-bundle
          path: artifact
